<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Wash Pro | Премиум учет</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            --secondary: #7c3aed;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #64748b;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-radius: 20px;
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --glow: 0 0 20px rgba(37, 99, 235, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--light);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(37, 99, 235, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(124, 58, 237, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Хедер */
        .header {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), var(--primary), transparent);
            animation: gradientMove 3s linear infinite;
        }

        @keyframes gradientMove {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
            box-shadow: var(--glow);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .logo-text h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--light), #a5b4fc);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo-text p {
            color: var(--gray);
            font-size: 14px;
        }

        /* Улучшенный номер машины */
        .plate-wrapper {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 3px;
            border-radius: 16px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 0 40px rgba(245, 158, 11, 0.5); }
        }

        .car-plate {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border-radius: 13px;
            padding: 12px 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }

        .russia-flag {
            width: 32px;
            height: 22px;
            background: linear-gradient(to bottom, white 33%, #1a47b8 33%, #1a47b8 66%, #cf2e2e 66%);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .plate-number {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 28px;
            font-weight: 900;
            letter-spacing: 4px;
            color: #1e293b;
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.8);
            background: white;
            padding: 5px 15px;
            border-radius: 8px;
            border: 2px solid #1e293b;
        }

        .region-code {
            font-family: 'Arial Black', sans-serif;
            font-size: 20px;
            font-weight: 900;
            color: white;
            background: #1e293b;
            padding: 5px 10px;
            border-radius: 8px;
            letter-spacing: 2px;
        }

        .edit-plate-btn {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.3);
            color: var(--primary);
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-plate-btn:hover {
            background: var(--primary);
            color: white;
            transform: rotate(15deg) scale(1.1);
        }

        /* Виджет погоды */
        .weather-premium {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 20px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 25px;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .weather-icon {
            font-size: 48px;
            color: var(--primary-light);
            animation: pulse 2s ease-in-out infinite;
        }

        .weather-info h3 {
            font-size: 36px;
            font-weight: 800;
            color: var(--light);
        }

        .weather-desc {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .weather-recommendation {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.2), rgba(16, 185, 129, 0.2));
            border: 1px solid rgba(5, 150, 105, 0.3);
            border-radius: 12px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 600;
        }

        .weather-recommendation.good {
            color: #34d399;
        }

        .weather-recommendation.bad {
            color: #f87171;
        }

        .weather-recommendation.warning {
            color: #fbbf24;
        }

        /* Навигация */
        .tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 15px 30px;
            color: var(--gray);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .tab-btn:hover {
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
            box-shadow: var(--glow);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Карточки */
        .card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), var(--primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: rgba(37, 99, 235, 0.3);
            box-shadow: 0 30px 60px -15px rgba(37, 99, 235, 0.3);
        }

        .card:hover::after {
            opacity: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary);
        }

        /* Химия */
        .chem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .chem-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .chem-item:hover {
            background: rgba(37, 99, 235, 0.05);
            border-color: rgba(37, 99, 235, 0.2);
        }

        .chem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chem-name {
            font-weight: 600;
            font-size: 18px;
            color: var(--light);
        }

        .chem-actions {
            display: flex;
            gap: 10px;
        }

        .chem-actions button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--gray);
            width: 35px;
            height: 35px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chem-actions button:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            transform: scale(1.1);
        }

        .chem-actions button.delete:hover {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }

        .chem-desc {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .stock-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .stock-slider {
            flex: 1;
            position: relative;
        }

        .stock-slider input {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
            transition: all 0.2s ease;
        }

        .stock-slider input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            margin-top: -8px;
        }

        .stock-slider input::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--primary-light);
            box-shadow: 0 0 20px var(--primary);
        }

        .stock-slider input::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .stock-slider input:hover::-webkit-slider-runnable-track {
            height: 10px;
        }

        .stock-value {
            color: var(--primary);
            font-weight: 700;
            min-width: 50px;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
        }

        /* Кнопка добавления химии */
        .add-chem-btn {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 15px 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-chem-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.4);
        }

        /* Кнопка карандаш - исправленная */
        .edit-algo-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin-left: 10px;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .edit-algo-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.5);
        }

        /* Корзина */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -500px;
            width: 450px;
            height: 100vh;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 1px solid rgba(37, 99, 235, 0.2);
            padding: 25px;
            overflow-y: auto;
        }

        .cart-sidebar.active {
            right: 0;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .cart-header h3 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-cart {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: var(--danger);
            width: 45px;
            height: 45px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-cart:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .cart-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item-info h4 {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: var(--warning);
            font-weight: 700;
            font-size: 18px;
        }

        .buy-btn {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
            font-size: 16px;
        }

        .buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(5, 150, 105, 0.4);
        }

        /* Кнопка корзины */
        .cart-button {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 999;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--glow);
            transition: all 0.3s ease;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .cart-button:hover {
            transform: rotate(10deg) scale(1.15);
        }

        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        /* История моек */
        .wash-history-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .wash-record {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .wash-record:hover {
            background: rgba(37, 99, 235, 0.05);
            border-color: rgba(37, 99, 235, 0.2);
        }

        .wash-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .wash-date {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delete-wash-btn {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: var(--danger);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-wash-btn:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.1);
        }

        .wash-chems {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .wash-chem-tag {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.2);
            color: var(--primary-light);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wash-notes {
            background: rgba(124, 58, 237, 0.1);
            border-left: 3px solid var(--secondary);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: #cbd5e1;
        }

        /* Финансы */
        .finance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .finance-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.1));
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 16px;
            padding: 20px;
        }

        .finance-card h3 {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .finance-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--light);
        }

        .finance-change {
            font-size: 14px;
            color: var(--success);
            margin-top: 5px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .transactions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-date {
            color: var(--gray);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .transaction-items {
            font-weight: 600;
        }

        .transaction-amount {
            color: var(--success);
            font-weight: 700;
            font-size: 18px;
            margin-right: 15px;
        }

        .delete-transaction-btn {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: var(--danger);
            width: 35px;
            height: 35px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-transaction-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            padding: 40px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .edit-step {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .step-input {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: white;
            font-size: 16px;
        }

        .step-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.save {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .modal-btn.cancel {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .cart-sidebar {
                width: 100%;
                right: -100%;
            }

            .plate-wrapper {
                width: 100%;
            }

            .car-plate {
                flex-wrap: wrap;
                justify-content: center;
            }

            .weather-premium {
                flex-direction: column;
                text-align: center;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                width: 100%;
                justify-content: center;
            }

            .finance-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Корзина -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> Корзина</h3>
            <button class="close-cart" id="closeCart"><i class="fas fa-times"></i></button>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <div class="cart-total" id="cartTotal" style="display: none;">
            <div style="font-size: 16px; color: var(--gray); margin-bottom: 5px;">Итого:</div>
            <div style="font-size: 28px; font-weight: 800; color: var(--warning);" id="totalPrice">0 ₽</div>
        </div>
        <button class="buy-btn" id="buyBtn"><i class="fas fa-shopping-bag"></i> Купить</button>
    </div>

    <!-- Кнопка корзины -->
    <button class="cart-button" id="cartButton">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-count" id="cartCount">0</span>
    </button>

    <!-- Модалка алгоритма -->
    <div class="modal" id="algorithmModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px; font-size: 24px;"><i class="fas fa-edit"></i> Редактировать алгоритм</h2>
            <div id="editStepsContainer"></div>
            <button class="add-chem-btn" onclick="addNewStep()" style="margin: 20px 0;">
                <i class="fas fa-plus"></i> Добавить шаг
            </button>
            <div class="modal-actions">
                <button class="modal-btn save" onclick="saveAlgorithm()">Сохранить</button>
                <button class="modal-btn cancel" onclick="closeAlgorithmModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модалка добавления химии -->
    <div class="modal" id="addChemModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px;"><i class="fas fa-plus"></i> Добавить химию</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Название</label>
                <input type="text" id="newChemName" class="step-input" placeholder="Например: 01 safe">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Цена (₽)</label>
                <input type="number" id="newChemPrice" class="step-input" placeholder="0">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Описание</label>
                <input type="text" id="newChemDesc" class="step-input" placeholder="Например: Бесконтактная пена">
            </div>
            <div class="modal-actions">
                <button class="modal-btn save" onclick="saveNewChem()">Сохранить</button>
                <button class="modal-btn cancel" onclick="closeAddChemModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модалка номера -->
    <div class="modal" id="plateModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px;"><i class="fas fa-car"></i> Изменить номер</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Номер (буква + 3 цифры + 2 буквы)</label>
                <input type="text" id="editPlateInput" class="step-input" maxlength="6" placeholder="А123БВ">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Регион (2-3 цифры)</label>
                <input type="text" id="editRegionInput" class="step-input" maxlength="3" placeholder="777">
            </div>
            <div class="modal-actions">
                <button class="modal-btn save" onclick="savePlateNumber()">Сохранить</button>
                <button class="modal-btn cancel" onclick="closePlateModal()">Отмена</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Хедер -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="logo-text">
                        <h1>CAR WASH PRO</h1>
                        <p>Премиум система учета</p>
                    </div>
                </div>

                <!-- Улучшенный номер машины -->
                <div class="plate-wrapper">
                    <div class="car-plate">
                        <div class="russia-flag"></div>
                        <div class="plate-number" id="plateNumber">А123БВ</div>
                        <div class="region-code" id="regionCode">777</div>
                    </div>
                </div>
                <button class="edit-plate-btn" id="editPlateBtn">
                    <i class="fas fa-pencil-alt"></i>
                </button>

                <!-- Погода с рекомендациями -->
                <div class="weather-premium" id="weatherWidget">
                    <i class="fas fa-sun weather-icon"></i>
                    <div class="weather-info">
                        <h3 id="weatherTemp">--°C</h3>
                        <div class="weather-desc" id="weatherDesc">Загрузка...</div>
                        <div class="weather-recommendation" id="weatherRecommendation">
                            ✅ Загрузка...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Навигация -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="chemistry">
                <i class="fas fa-flask"></i> Моя химия
            </button>
            <button class="tab-btn" data-tab="washHistory">
                <i class="fas fa-history"></i> История моек
            </button>
            <button class="tab-btn" data-tab="algorithm">
                <i class="fas fa-list-ol"></i> Алгоритм мойки
            </button>
            <button class="tab-btn" data-tab="finance">
                <i class="fas fa-chart-pie"></i> Финансы
            </button>
        </div>

        <!-- Вкладка Химии -->
        <div id="chemistry" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-prescription-bottle"></i> В наличии</h2>
                    <button class="add-chem-btn" onclick="openAddChemModal()">
                        <i class="fas fa-plus"></i> Добавить
                    </button>
                </div>
                <div class="chem-grid" id="inStockList"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-shopping-cart"></i> Нет в наличии</h2>
                </div>
                <div class="chem-grid" id="outOfStockList"></div>
            </div>
        </div>

        <!-- Вкладка История моек -->
        <div id="washHistory" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-history"></i> История моек</h2>
                    <button class="add-chem-btn" onclick="openAddWashModal()" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
                        <i class="fas fa-plus"></i> Добавить мойку
                    </button>
                </div>
                <div class="wash-history-grid" id="washHistoryList"></div>
            </div>
        </div>

        <!-- Вкладка Алгоритма -->
        <div id="algorithm" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-spray-can"></i> Алгоритм мойки</h2>
                    <button class="edit-algo-btn" onclick="openAlgorithmModal()">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
                <div class="algo-steps" id="algoSteps"></div>
            </div>
        </div>

        <!-- Вкладка Финансы -->
        <div id="finance" class="tab-content">
            <div class="finance-grid">
                <div class="finance-card">
                    <h3><i class="fas fa-wallet"></i> Всего потрачено</h3>
                    <div class="finance-value" id="totalSpent">0 ₽</div>
                    <div class="finance-change" id="monthlyChange">+0 ₽ за месяц</div>
                </div>
                <div class="finance-card">
                    <h3><i class="fas fa-shopping-bag"></i> Количество покупок</h3>
                    <div class="finance-value" id="purchasesCount">0</div>
                </div>
                <div class="finance-card">
                    <h3><i class="fas fa-calendar"></i> Средний чек</h3>
                    <div class="finance-value" id="averageCheck">0 ₽</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-chart-line"></i> Динамика трат</h3>
                <canvas id="expenseChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-receipt"></i> История покупок</h2>
                </div>
                <div class="transactions-list" id="transactionsList"></div>
            </div>
        </div>
    </div>

    <!-- Модалка добавления мойки -->
    <div class="modal" id="addWashModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px;"><i class="fas fa-soap"></i> Добавить мойку</h2>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Дата</label>
                <input type="date" id="washDate" class="step-input" value="{{ new Date().toISOString().split('T')[0] }}">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Использованная химия</label>
                <div style="max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px;" id="washChemsChecklist"></div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px;">Заметки</label>
                <textarea id="washNotes" class="step-input" rows="3" placeholder="Например: Особо грязные колеса..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn save" onclick="saveWash()">Сохранить</button>
                <button class="modal-btn cancel" onclick="closeAddWashModal()">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        // Данные
        let chemicals = JSON.parse(localStorage.getItem('carWashChemicals')) || [
            { id: 1, name: "01 safe (первая фаза)", price: 631, desc: "Бесконтактная пена", stock: 80, inStock: true },
            { id: 2, name: "14 multicomplex", price: 335, desc: "Химчистка салона", stock: 65, inStock: true },
            { id: 3, name: "22 lord stone", price: 458, desc: "Водный камень", stock: 40, inStock: true },
            { id: 4, name: "Lavr storm", price: 501, desc: "Контактная пена", stock: 30, inStock: true },
            { id: 5, name: "32 black kiss", price: 388, desc: "Чернитель шин", stock: 25, inStock: true },
            { id: 6, name: "27 black round", price: 561, desc: "Гелевый чернитель", stock: 90, inStock: true },
            { id: 7, name: "Губка крупнопористая", price: 408, desc: "Для контактной мойки", stock: 100, inStock: true },
            { id: 8, name: "Полироль салона lcse", price: 426, desc: "Уход за пластиком", stock: 60, inStock: true },
            { id: 9, name: "Средство для экранов attace", price: 350, desc: "Очистка дисплеев", stock: 75, inStock: true },
            { id: 10, name: "33 quartz energy", price: 455, desc: "Кварцевое покрытие", stock: 20, inStock: true },
            { id: 11, name: "Тряпка микрофибра", price: 400, desc: "Для сушки", stock: 95, inStock: true },
            { id: 12, name: "Тряпка резиновая", price: 186, desc: "Для сушки стёкол", stock: 50, inStock: true },
            { id: 13, name: "Щетка для шин", price: 369, desc: "Очистка резины", stock: 100, inStock: true },
            { id: 14, name: "Щетка для дисков из микрофибры", price: 350, desc: "Чистка дисков", stock: 100, inStock: true },
            { id: 15, name: "03 too shampoo", price: 350, desc: "Шампунь для мойки", stock: 0, inStock: false },
            { id: 16, name: "Очиститель резины detail", price: 450, desc: "Для резиновых уплотнителей", stock: 0, inStock: false },
            { id: 17, name: "28 bug fix", price: 386, desc: "От насекомых", stock: 0, inStock: false },
            { id: 18, name: "Очиститель дисков (iron detail)", price: 571, desc: "Сильное средство для дисков", stock: 0, inStock: false },
            { id: 19, name: "Polish fiber", price: 382, desc: "Тряпка для полировки", stock: 0, inStock: false },
            { id: 20, name: "Glass fiber", price: 338, desc: "Для стёкол", stock: 0, inStock: false },
        ];

        let algorithm = JSON.parse(localStorage.getItem('carWashAlgorithm')) || [
            "Намочить всю машину водой",
            "Пена бесконтактная: Нанести → ждать 3-5 мин → смыть",
            "Колёса и арки: Очистить диски и шины → смыть",
            "Пена контактная (2 ведра): Мыть кузов сверху вниз → сполоснуть",
            "Гидрофоб (ВАЖНО): Нанести на влажный кузов → ждать ~1 мин → смыть водой",
            "Сушка: Воздуховодка → резиновая тряпка → микрофибра",
            "Финиш: Колёса (чернитель) → салон"
        ];

        let washHistory = JSON.parse(localStorage.getItem('carWashHistory')) || [];
        let cartItems = JSON.parse(localStorage.getItem('carWashCart')) || [];
        let finances = JSON.parse(localStorage.getItem('carWashFinances')) || {
            transactions: [],
            totalSpent: 0
        };

        let carPlate = JSON.parse(localStorage.getItem('carPlate')) || {
            number: 'А123БВ',
            region: '777'
        };

        let expenseChart = null;

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            loadWeather();
            renderChemicals();
            renderAlgorithm();
            renderWashHistory();
            updateCart();
            updateFinanceStats();
            setupEventListeners();
            setInterval(loadWeather, 30 * 60 * 1000);
            updatePlateDisplay();
        });

        // Погода
        async function loadWeather() {
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=57.63&longitude=39.87&current_weather=true&timezone=Europe%2FMoscow');
                const data = await response.json();
                
                if (data.current_weather) {
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    
                    document.getElementById('weatherTemp').textContent = `${temp}°C`;
                    const weatherDesc = getWeatherDescription(code);
                    document.getElementById('weatherDesc').textContent = weatherDesc;
                    
                    const recElement = document.getElementById('weatherRecommendation');
                    const weatherIcon = document.querySelector('.weather-icon');
                    
                    if (temp < 5) {
                        recElement.className = 'weather-recommendation bad';
                        recElement.innerHTML = '❌ Слишком холодно (ниже +5°C), вода замерзнет';
                        weatherIcon.style.color = '#f87171';
                    } else if (weatherDesc.includes('Дождь') || weatherDesc.includes('Снег')) {
                        recElement.className = 'weather-recommendation bad';
                        recElement.innerHTML = '❌ Идет осадки, не рекомендуется мойка';
                        weatherIcon.style.color = '#f87171';
                    } else if (temp > 30) {
                        recElement.className = 'weather-recommendation warning';
                        recElement.innerHTML = '⚠️ Жарко, мыть в тени';
                        weatherIcon.style.color = '#fbbf24';
                    } else {
                        recElement.className = 'weather-recommendation good';
                        recElement.innerHTML = '✅ Отличная погода для мойки';
                        weatherIcon.style.color = '#34d399';
                    }
                    
                    weatherIcon.className = `fas ${getWeatherIcon(code)} weather-icon`;
                }
            } catch (error) {
                console.error('Ошибка погоды:', error);
            }
        }

        function getWeatherDescription(code) {
            if (code === 0) return 'Ясно';
            if (code <= 3) return 'Переменная облачность';
            if (code <= 48) return 'Туман';
            if (code <= 55) return 'Морось';
            if (code <= 65) return 'Дождь';
            if (code <= 77) return 'Снег';
            if (code <= 82) return 'Ливень';
            if (code <= 86) return 'Снегопад';
            if (code <= 99) return 'Гроза';
            return 'Облачно';
        }

        function getWeatherIcon(code) {
            if (code === 0) return 'fa-sun';
            if (code <= 3) return 'fa-cloud-sun';
            if (code <= 48) return 'fa-smog';
            if (code <= 55) return 'fa-cloud-rain';
            if (code <= 65) return 'fa-cloud-showers-heavy';
            if (code <= 77) return 'fa-snowflake';
            if (code <= 82) return 'fa-cloud-showers-heavy';
            if (code <= 86) return 'fa-snowman';
            if (code <= 99) return 'fa-bolt';
            return 'fa-cloud';
        }

        // Химия
        function renderChemicals() {
            const inStock = document.getElementById('inStockList');
            const outStock = document.getElementById('outOfStockList');
            
            inStock.innerHTML = '';
            outStock.innerHTML = '';

            chemicals.forEach(chem => {
                const element = createChemElement(chem);
                if (chem.inStock) {
                    inStock.appendChild(element);
                } else {
                    outStock.appendChild(element);
                }
            });
        }

        function createChemElement(chem) {
            const div = document.createElement('div');
            div.className = `chem-item ${chem.inStock ? '' : 'out-of-stock'}`;
            const inCart = cartItems.some(item => item.id === chem.id);
            
            div.innerHTML = `
                <div class="chem-header">
                    <span class="chem-name">${chem.name}</span>
                    <div class="chem-actions">
                        <button class="delete" onclick="deleteChem(${chem.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="chem-desc">${chem.desc}</div>
                <div class="stock-control">
                    <span class="stock-value">${chem.stock}%</span>
                    <div class="stock-slider">
                        <input type="range" min="0" max="100" value="${chem.stock}" 
                               oninput="updateStock(${chem.id}, this.value)" ${!chem.inStock ? 'disabled' : ''}>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="add-to-cart-btn" style="flex: 1; ${inCart ? 'background: linear-gradient(135deg, var(--success), #059669);' : 'background: linear-gradient(135deg, var(--warning), #f97316);'}" 
                            onclick="toggleCart(${chem.id})" ${!chem.inStock ? 'disabled' : ''}>
                        ${inCart ? '<i class="fas fa-check"></i> В корзине' : '<i class="fas fa-cart-plus"></i> В корзину'}
                    </button>
                    <button class="toggle-stock-btn" style="width: 45px;" onclick="toggleStock(${chem.id})">
                        <i class="fas ${chem.inStock ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                    </button>
                </div>
            `;
            return div;
        }

        function updateStock(id, value) {
            const chem = chemicals.find(c => c.id === id);
            chem.stock = parseInt(value);
            saveChemicals();
        }

        function toggleStock(id) {
            const chem = chemicals.find(c => c.id === id);
            chem.inStock = !chem.inStock;
            if (!chem.inStock) {
                chem.stock = 0;
                cartItems = cartItems.filter(item => item.id !== id);
                saveCart();
            }
            saveChemicals();
            renderChemicals();
            updateCart();
            showNotification(chem.inStock ? 'Товар теперь в наличии' : 'Товар закончился');
        }

        function toggleCart(id) {
            const chem = chemicals.find(c => c.id === id);
            const index = cartItems.findIndex(item => item.id === id);
            
            if (index === -1) {
                cartItems.push({
                    id: chem.id,
                    name: chem.name,
                    price: chem.price,
                    desc: chem.desc
                });
                showNotification('Товар добавлен в корзину');
            } else {
                cartItems.splice(index, 1);
                showNotification('Товар удален из корзины');
            }
            
            saveCart();
            updateCart();
            renderChemicals();
        }

        function deleteChem(id) {
            if (confirm('Удалить этот товар?')) {
                chemicals = chemicals.filter(c => c.id !== id);
                cartItems = cartItems.filter(item => item.id !== id);
                saveChemicals();
                saveCart();
                renderChemicals();
                updateCart();
                showNotification('Товар удален');
            }
        }

        function saveChemicals() {
            localStorage.setItem('carWashChemicals', JSON.stringify(chemicals));
        }

        // Корзина
        function updateCart() {
            const cartItemsDiv = document.getElementById('cartItems');
            const cartTotalDiv = document.getElementById('cartTotal');
            const totalPriceSpan = document.getElementById('totalPrice');
            const cartCount = document.getElementById('cartCount');
            
            cartCount.textContent = cartItems.length;
            
            if (cartItems.length === 0) {
                cartItemsDiv.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 40px;">Корзина пуста</div>';
                cartTotalDiv.style.display = 'none';
                return;
            }
            
            cartTotalDiv.style.display = 'block';
            let total = 0;
            
            cartItemsDiv.innerHTML = cartItems.map(item => {
                total += item.price;
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <div style="color: var(--gray); font-size: 12px;">${item.desc}</div>
                        </div>
                        <div class="cart-item-price">${item.price} ₽</div>
                    </div>
                `;
            }).join('');
            
            totalPriceSpan.textContent = `${total.toLocaleString()} ₽`;
        }

        function saveCart() {
            localStorage.setItem('carWashCart', JSON.stringify(cartItems));
        }

        document.getElementById('buyBtn').addEventListener('click', function() {
            if (cartItems.length === 0) {
                showNotification('Корзина пуста');
                return;
            }
            
            const total = cartItems.reduce((sum, item) => sum + item.price, 0);
            
            finances.transactions.push({
                date: new Date().toISOString(),
                items: [...cartItems],
                total: total
            });
            
            finances.totalSpent += total;
            
            cartItems.forEach(item => {
                const chem = chemicals.find(c => c.id === item.id);
                if (chem) {
                    chem.stock = Math.max(0, chem.stock - 10);
                }
            });
            
            cartItems = [];
            
            saveChemicals();
            saveCart();
            localStorage.setItem('carWashFinances', JSON.stringify(finances));
            
            updateCart();
            renderChemicals();
            updateFinanceStats();
            showNotification('Покупка совершена!');
            document.getElementById('cartSidebar').classList.remove('active');
        });

        // История моек
        function renderWashHistory() {
            const list = document.getElementById('washHistoryList');
            
            if (washHistory.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 40px;">Нет записей о мойках</div>';
                return;
            }
            
            list.innerHTML = washHistory.slice().reverse().map((wash, index) => {
                const originalIndex = washHistory.length - 1 - index;
                return `
                    <div class="wash-record">
                        <div class="wash-record-header">
                            <div class="wash-date">
                                <i class="far fa-calendar"></i> ${wash.date}
                            </div>
                            <button class="delete-wash-btn" onclick="deleteWash(${originalIndex})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ${wash.chems && wash.chems.length > 0 ? `
                            <div class="wash-chems">
                                ${wash.chems.map(chem => `
                                    <span class="wash-chem-tag">
                                        <i class="fas fa-prescription-bottle"></i> ${chem}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${wash.notes ? `
                            <div class="wash-notes">
                                <i class="fas fa-comment"></i> ${wash.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function deleteWash(index) {
            if (confirm('Удалить запись о мойке?')) {
                washHistory.splice(index, 1);
                localStorage.setItem('carWashHistory', JSON.stringify(washHistory));
                renderWashHistory();
                showNotification('Запись удалена');
            }
        }

        function openAddWashModal() {
            const checklist = document.getElementById('washChemsChecklist');
            checklist.innerHTML = chemicals.filter(c => c.inStock).map(chem => `
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" value="${chem.name}" style="width: 18px; height: 18px;">
                    <span>${chem.name}</span>
                </label>
            `).join('');
            
            document.getElementById('washDate').valueAsDate = new Date();
            document.getElementById('washNotes').value = '';
            document.getElementById('addWashModal').classList.add('active');
        }

        function closeAddWashModal() {
            document.getElementById('addWashModal').classList.remove('active');
        }

        function saveWash() {
            const date = document.getElementById('washDate').value;
            const notes = document.getElementById('washNotes').value;
            const chems = [];
            
            document.querySelectorAll('#washChemsChecklist input:checked').forEach(cb => {
                chems.push(cb.value);
            });
            
            washHistory.push({
                date: new Date(date).toLocaleDateString('ru-RU', {day: 'numeric', month: 'long', year: 'numeric'}),
                chems: chems,
                notes: notes || null
            });
            
            localStorage.setItem('carWashHistory', JSON.stringify(washHistory));
            closeAddWashModal();
            renderWashHistory();
            showNotification('Мойка добавлена');
        }

        // Алгоритм
        function renderAlgorithm() {
            const container = document.getElementById('algoSteps');
            container.innerHTML = algorithm.map((step, i) => `
                <div class="algo-step" style="margin-bottom: 15px; display: flex; align-items: center; gap: 20px;">
                    <span style="background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">${i + 1}</span>
                    <span>${step}</span>
                </div>
            `).join('');
        }

        function openAlgorithmModal() {
            const container = document.getElementById('editStepsContainer');
            container.innerHTML = algorithm.map((step, i) => `
                <div class="edit-step">
                    <span class="step-number">${i + 1}</span>
                    <input type="text" class="step-input" value="${step}" data-index="${i}">
                </div>
            `).join('');
            
            document.getElementById('algorithmModal').classList.add('active');
        }

        function closeAlgorithmModal() {
            document.getElementById('algorithmModal').classList.remove('active');
        }

        function addNewStep() {
            algorithm.push('Новый шаг');
            openAlgorithmModal();
        }

        function saveAlgorithm() {
            const inputs = document.querySelectorAll('#editStepsContainer .step-input');
            algorithm = Array.from(inputs).map(input => input.value);
            localStorage.setItem('carWashAlgorithm', JSON.stringify(algorithm));
            renderAlgorithm();
            closeAlgorithmModal();
            showNotification('Алгоритм сохранен');
        }

        // Финансы
        function updateFinanceStats() {
            const total = finances.totalSpent;
            const count = finances.transactions.length;
            const avg = count > 0 ? Math.round(total / count) : 0;
            
            document.getElementById('totalSpent').textContent = `${total.toLocaleString()} ₽`;
            document.getElementById('purchasesCount').textContent = count;
            document.getElementById('averageCheck').textContent = `${avg.toLocaleString()} ₽`;
            
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthTotal = finances.transactions
                .filter(t => new Date(t.date) >= monthStart)
                .reduce((sum, t) => sum + t.total, 0);
            document.getElementById('monthlyChange').textContent = `+${monthTotal.toLocaleString()} ₽ за месяц`;
            
            renderTransactions();
            renderExpenseChart();
        }

        function renderTransactions() {
            const list = document.getElementById('transactionsList');
            
            if (finances.transactions.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 40px;">Нет покупок</div>';
                return;
            }
            
            list.innerHTML = finances.transactions.slice().reverse().map((t, index) => {
                const originalIndex = finances.transactions.length - 1 - index;
                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-date">
                                ${new Date(t.date).toLocaleDateString('ru-RU')}
                            </div>
                            <div class="transaction-items">
                                ${t.items.length} товаров
                            </div>
                        </div>
                        <div class="transaction-amount">+${t.total.toLocaleString()} ₽</div>
                        <button class="delete-transaction-btn" onclick="deleteTransaction(${originalIndex})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function deleteTransaction(index) {
            if (confirm('Удалить запись о покупке?')) {
                const removed = finances.transactions[index];
                finances.totalSpent -= removed.total;
                finances.transactions.splice(index, 1);
                
                localStorage.setItem('carWashFinances', JSON.stringify(finances));
                updateFinanceStats();
                showNotification('Покупка удалена');
            }
        }

        function renderExpenseChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            const months = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
            const monthlyData = new Array(12).fill(0);
            
            finances.transactions.forEach(t => {
                const date = new Date(t.date);
                monthlyData[date.getMonth()] += t.total;
            });
            
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            expenseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Траты по месяцам',
                        data: monthlyData,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        // Номер машины
        function updatePlateDisplay() {
            document.getElementById('plateNumber').textContent = carPlate.number;
            document.getElementById('regionCode').textContent = carPlate.region;
        }

        document.getElementById('editPlateBtn').addEventListener('click', function() {
            document.getElementById('editPlateInput').value = carPlate.number;
            document.getElementById('editRegionInput').value = carPlate.region;
            document.getElementById('plateModal').classList.add('active');
        });

        function savePlateNumber() {
            const number = document.getElementById('editPlateInput').value.toUpperCase();
            const region = document.getElementById('editRegionInput').value;
            
            const plateRegex = /^[А-Я]{1}\d{3}[А-Я]{2}$/;
            const regionRegex = /^\d{2,3}$/;
            
            if (!plateRegex.test(number)) {
                alert('Неверный формат номера');
                return;
            }
            
            if (!regionRegex.test(region)) {
                alert('Неверный формат региона');
                return;
            }
            
            carPlate = { number, region };
            localStorage.setItem('carPlate', JSON.stringify(carPlate));
            updatePlateDisplay();
            closePlateModal();
            showNotification('Номер сохранен');
        }

        function closePlateModal() {
            document.getElementById('plateModal').classList.remove('active');
        }

        // Модалки химии
        function openAddChemModal() {
            document.getElementById('addChemModal').classList.add('active');
        }

        function closeAddChemModal() {
            document.getElementById('addChemModal').classList.remove('active');
            document.getElementById('newChemName').value = '';
            document.getElementById('newChemPrice').value = '';
            document.getElementById('newChemDesc').value = '';
        }

        function saveNewChem() {
            const name = document.getElementById('newChemName').value;
            const price = parseInt(document.getElementById('newChemPrice').value);
            const desc = document.getElementById('newChemDesc').value;
            
            if (!name || !price) {
                alert('Заполните название и цену');
                return;
            }
            
            const newId = Math.max(...chemicals.map(c => c.id), 0) + 1;
            chemicals.push({
                id: newId,
                name: name,
                price: price,
                desc: desc || 'Нет описания',
                stock: 100,
                inStock: true
            });
            
            saveChemicals();
            renderChemicals();
            closeAddChemModal();
            showNotification('Товар добавлен');
        }

        // Общие функции
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 120px;
                background: linear-gradient(135deg, var(--primary), var(--secondary));
                color: white;
                padding: 15px 30px;
                border-radius: 50px;
                font-weight: 500;
                box-shadow: var(--glow);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2000);
        }

        function setupEventListeners() {
            // Табы
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    document.querySelectorAll('.tab-btn, .tab-content').forEach(el => {
                        el.classList.remove('active');
                    });
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // Корзина
            document.getElementById('cartButton').addEventListener('click', () => {
                document.getElementById('cartSidebar').classList.add('active');
            });

            document.getElementById('closeCart').addEventListener('click', () => {
                document.getElementById('cartSidebar').classList.remove('active');
            });

            // Закрытие модалок по клику вне
            document.addEventListener('click', (e) => {
                const cart = document.getElementById('cartSidebar');
                const cartBtn = document.getElementById('cartButton');
                
                if (!cart.contains(e.target) && !cartBtn.contains(e.target) && cart.classList.contains('active')) {
                    cart.classList.remove('active');
                }
                
                // Закрытие модалок по клику на фон
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
        }

        // Добавляем стили для кнопок
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100px); opacity: 0; }
            }
            
            .add-to-cart-btn {
                color: white;
                border: none;
                padding: 10px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .add-to-cart-btn:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            }
            
            .add-to-cart-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .toggle-stock-btn {
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: var(--gray);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .toggle-stock-btn:hover {
                background: rgba(37, 99, 235, 0.1);
                color: var(--primary);
            }
            
            .out-of-stock {
                opacity: 0.7;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
